"use strict";var lt=Object.defineProperty;var Et=Object.getOwnPropertyDescriptor;var Ft=Object.getOwnPropertyNames;var Nt=Object.prototype.hasOwnProperty;var Pt=(c,l)=>{for(var t in l)lt(c,t,{get:l[t],enumerable:!0})},At=(c,l,t,e)=>{if(l&&typeof l=="object"||typeof l=="function")for(let s of Ft(l))!Nt.call(c,s)&&s!==t&&lt(c,s,{get:()=>l[s],enumerable:!(e=Et(l,s))||e.enumerable});return c};var Lt=c=>At(lt({},"__esModule",{value:!0}),c);var Rt={};Pt(Rt,{default:()=>st});module.exports=Lt(Rt);var O=require("obsidian");var ct={taskFolder:"Tasks",statuses:["Backlog","In Progress","Blocked","Review","Done"],templateFields:[{key:"title",label:"Title",type:"text"},{key:"status",label:"Status",type:"status"},{key:"priority",label:"Priority",type:"status"},{key:"assignee",label:"Assignee",type:"people"},{key:"startDate",label:"Start Date",type:"date"},{key:"endDate",label:"End Date",type:"date"},{key:"tags",label:"Tags",type:"tags"},{key:"crNumber",label:"CR Number",type:"text"},{key:"plannedStart",label:"Planned start date",type:"date"},{key:"plannedEnd",label:"Planned end date",type:"date"},{key:"actualStart",label:"Actual start date",type:"date"},{key:"actualEnd",label:"Actual end date",type:"date"},{key:"notes",label:"Notes",type:"freetext"}],gridVisibleColumns:["title","status","priority","assignee","startDate","endDate","tags","notes"],crFolder:"Change Requests",crTemplateFields:[{key:"number",label:"CR Number",type:"text"},{key:"title",label:"Title",type:"text"},{key:"emailSubject",label:"Email Subject",type:"text"},{key:"solutionDesign",label:"Solution design link",type:"url"},{key:"description",label:"Description",type:"text"}]};var G=require("obsidian"),Z=class extends G.PluginSettingTab{constructor(l,t){super(l,t),this.plugin=t}display(){let{containerEl:l}=this;l.empty(),l.createEl("h2",{text:"Kanban Board & Task Grid"}),new G.Setting(l).setName("Task folder").setDesc("Folder where task notes are stored").addText(t=>{t.setPlaceholder("Tasks").setValue(this.plugin.settings.taskFolder).onChange(async e=>{this.plugin.settings.taskFolder=e||"Tasks",await this.plugin.saveSettings()})}),new G.Setting(l).setName("Statuses (comma-separated)").setDesc("Columns shown in the Kanban view").addText(t=>{t.setPlaceholder("Backlog, In Progress, Blocked, Review, Done").setValue(this.plugin.settings.statuses.join(", ")).onChange(async e=>{this.plugin.settings.statuses=e.split(",").map(s=>s.trim()).filter(Boolean),await this.plugin.saveSettings()})}),new G.Setting(l).setName("Grid visible columns (keys, comma-separated)").setDesc("Which fields to display in the grid").addText(t=>{t.setPlaceholder("title, status, priority, assignee, due, tags").setValue(this.plugin.settings.gridVisibleColumns.join(", ")).onChange(async e=>{this.plugin.settings.gridVisibleColumns=e.split(",").map(s=>s.trim()).filter(Boolean),await this.plugin.saveSettings()})}),l.createEl("p",{text:"Template fields can be edited in JSON within your data.json for now. A richer editor will be added."})}};var _=require("obsidian");async function dt(c,l){let t=(0,_.normalizePath)(l);try{await c.vault.createFolder(t)}catch(e){}}function tt(c){let l=["---"];for(let[t,e]of Object.entries(c))if(e!=null)if(Array.isArray(e)){if(e.length===0)continue;let s=e.map(a=>Mt(a)).join(", ");l.push(`${t}: [${s}]`)}else{if(typeof e=="string"&&e.trim()==="")continue;if(typeof e=="string"&&e.includes(`
`)){l.push(`${t}: |`);let s=e.split(`
`);for(let a of s)l.push(`  ${a}`)}else{let s=It(e);l.push(`${t}: ${s}`)}}return l.push("---"),l.join(`
`)}function It(c){return c==null?"":typeof c=="string"?c.includes(`
`)?`|
`+c.split(`
`).map(t=>"  "+t).join(`
`):/[:#\-]|^\s|\s$/.test(c)?JSON.stringify(c):c:String(c)}function Mt(c){if(c==null)return"";let l=String(c);return/[",\[\]:\n]/.test(l)||/^\s|\s$/.test(l)?'"'+l.replace(/"/g,'""')+'"':l}async function vt(c,l){var a;let t=(0,_.normalizePath)(l.taskFolder),e=[],s=c.vault.getMarkdownFiles().filter(o=>o.path.startsWith(t+"/"));for(let o of s){let d=c.metadataCache.getFileCache(o),g=(a=d==null?void 0:d.frontmatter)!=null?a:{};e.push({filePath:o.path,fileName:o.name.replace(/\.md$/,""),frontmatter:g})}return e}async function V(c,l,t){var i,n,m,y,f,u,E;let e=await c.vault.read(l),s=c.metadataCache.getFileCache(l),a=(m=(n=(i=s==null?void 0:s.frontmatterPosition)==null?void 0:i.start)==null?void 0:n.offset)!=null?m:-1,o=(u=(f=(y=s==null?void 0:s.frontmatterPosition)==null?void 0:y.end)==null?void 0:f.offset)!=null?u:-1,g={...(E=s==null?void 0:s.frontmatter)!=null?E:{},...t},p=tt(g),v;if(a>=0&&o>a){let D=e.slice(o),L=D.startsWith(`
`)?"":`
`;v=e.slice(0,a)+p+L+D}else{let D=e,L=D.length===0||D.startsWith(`
`)?`
`:`

`;v=p+L+D}await c.vault.modify(l,v)}function Tt(c){return`[[${(0,_.normalizePath)(c)}]]`}async function pt(c,l,t){var a;let e=(0,_.normalizePath)(l.crFolder||"Change Requests"),s=c.vault.getMarkdownFiles().filter(o=>o.path.startsWith(e+"/"));for(let o of s){let d=(a=c.metadataCache.getFileCache(o))==null?void 0:a.frontmatter;if(d&&String(d.number||d.crNumber||"").toLowerCase()===t.toLowerCase()||o.name.toLowerCase().startsWith(t.toLowerCase()+" "))return o}return null}async function wt(c,l){var d;let t=(0,_.normalizePath)(l.crFolder||"Change Requests"),e=c.vault.getMarkdownFiles().filter(g=>g.path.startsWith(t+"/")),s=0,a=/^CR-(\d+)/i;for(let g of e){let p=(d=c.metadataCache.getFileCache(g))==null?void 0:d.frontmatter,v=String((p==null?void 0:p.number)||(p==null?void 0:p.crNumber)||""),i=a.exec(v);if(i){let m=parseInt(i[1],10);Number.isNaN(m)||(s=Math.max(s,m))}let n=a.exec(g.name);if(n){let m=parseInt(n[1],10);Number.isNaN(m)||(s=Math.max(s,m))}}return`CR-${s+1}`}var C=require("obsidian");var K="kb-board-tabs-view",et=class extends C.ItemView{constructor(t,e,s){super(t);this.tasks=[];this.filterQuery="";this.active="grid";this.settings=e,this.persistSettings=s}async promptText(t,e="",s=""){return new Promise(a=>{let o=this;class d extends C.Modal{constructor(){super(o.app);this.value=s;this.setTitle(t);let i=this.contentEl.createDiv({cls:"kb-prompt"}),n=i.createEl("input",{type:"text"});n.placeholder=e,n.value=s,n.oninput=()=>{this.value=n.value.trim()};let m=i.createDiv({cls:"kb-prompt-actions"}),y=m.createEl("button",{text:"OK"}),f=m.createEl("button",{text:"Cancel"});y.onclick=()=>{this.close(),a(this.value||void 0)},f.onclick=()=>{this.close(),a(void 0)},n.onkeydown=u=>{u.key==="Enter"&&y.click()},setTimeout(()=>n.focus(),0)}}new d().open()})}getViewType(){return K}getDisplayText(){return"Tasks"}getIcon(){return"layout-grid"}async onOpen(){this.contentEl.addClass("kb-container"),this.registerEvent(this.app.metadataCache.on("changed",(0,C.debounce)(()=>this.reload(),300))),this.registerEvent(this.app.vault.on("modify",(0,C.debounce)(()=>this.reload(),300))),await this.reload()}async reload(){this.tasks=await vt(this.app,this.settings),this.render()}render(){let t=this.contentEl;t.empty();let e=t.createDiv({cls:"kb-tabs"}),s=e.createEl("button",{text:"Grid"});s.addClass("kb-tab"),this.active==="grid"&&s.addClass("is-active"),s.onclick=()=>{this.active="grid",this.render()};let a=e.createEl("button",{text:"Board"});a.addClass("kb-tab"),this.active==="board"&&a.addClass("is-active"),a.onclick=()=>{this.active="board",this.render()};let d=t.createDiv({cls:"kb-toolbar"}).createEl("input",{type:"search"});d.addClass("kb-input"),d.placeholder="Filter...",d.value=this.filterQuery,d.oninput=g=>{let p=g.target;this.filterQuery=p.value.trim().toLowerCase(),this.active==="grid"?this.renderGrid(t):this.renderBoard(t)},this.active==="grid"?this.renderGrid(t):this.renderBoard(t)}getFilteredTasks(){let t=this.filterQuery;return t?this.tasks.filter(e=>e.fileName.toLowerCase().includes(t)?!0:this.settings.gridVisibleColumns.some(s=>{var a;return String((a=e.frontmatter[s])!=null?a:"").toLowerCase().includes(t)})):this.tasks}renderGrid(t){let e=t.querySelector(".kb-grid-wrap");e&&e.remove();let a=t.createDiv({cls:"kb-grid-wrap"}).createEl("table");a.addClass("kb-table");let d=a.createEl("thead").createEl("tr");for(let p of this.settings.gridVisibleColumns)d.createEl("th",{text:p});d.createEl("th",{text:"Archived"}),d.createEl("th",{text:"Open"});let g=a.createEl("tbody");for(let p of this.getFilteredTasks()){let v=g.createEl("tr"),i=!!p.frontmatter.archived;i&&v.addClass("kb-row-archived");for(let f of this.settings.gridVisibleColumns){let u=p.frontmatter[f],E=v.createEl("td"),D=Array.isArray(u)?u.join(", "):String(u!=null?u:"");D.includes(`
`)?E.innerHTML=D.replace(/\n/g,"<br>"):E.textContent=D}v.createEl("td").createSpan({text:i?"Yes":"No"});let y=v.createEl("td").createEl("button",{text:"Open"});y.addClass("kb-card-btn"),y.onclick=async()=>{let f=this.app.vault.getAbstractFileByPath(p.filePath);f instanceof C.TFile&&await this.app.workspace.getLeaf(!0).openFile(f)}}}renderBoard(t){var p,v;let e=t.querySelector(".kb-kanban");e&&e.remove();let s=t.createDiv({cls:"kb-kanban kb-kanban-horizontal",attr:{draggable:"false"}}),a=new Map;for(let i of this.settings.statuses)a.set(i,[]);for(let i of this.getFilteredTasks()){let n=(p=i.frontmatter.status)!=null?p:this.settings.statuses[0];((v=a.get(n))!=null?v:a.get(this.settings.statuses[0])).push(i)}for(let[i,n]of Array.from(a.entries()))n.sort((m,y)=>{var L,h;let f=Number((L=m.frontmatter.order)!=null?L:NaN),u=Number((h=y.frontmatter.order)!=null?h:NaN);if(!Number.isNaN(f)&&!Number.isNaN(u)&&f!==u)return f-u;let E=m.frontmatter.createdAt?new Date(String(m.frontmatter.createdAt)).getTime():0,D=y.frontmatter.createdAt?new Date(String(y.frontmatter.createdAt)).getTime():0;return E-D});let o={dragIndex:-1,onDragStart:(i,n)=>{var m;(m=n.dataTransfer)==null||m.setData("application/x-kb-col",String(i)),n.dataTransfer&&(n.dataTransfer.effectAllowed="move"),o.dragIndex=i},onDropOnIndex:async i=>{var u;let n=o.dragIndex,m=i;if(n<0||m<0||n===m)return;let y=this.settings.statuses,[f]=y.splice(n,1);y.splice(m,0,f),await((u=this.persistSettings)==null?void 0:u.call(this)),this.renderBoard(t)}};this.settings.statuses.forEach((i,n)=>{var S,F,I,j,J;let m=s.createDiv({cls:"kb-column",attr:{"data-col-index":String(n)}});m.ondragover=r=>{var A;((A=r.dataTransfer)==null?void 0:A.types.includes("application/x-kb-col"))?(r.preventDefault(),r.currentTarget.classList.add("kb-col-hover")):(r.dataTransfer&&(r.dataTransfer.dropEffect="move"),r.preventDefault(),u.classList.add("kb-dropzone-hover"))},m.ondragleave=r=>{r.currentTarget.classList.remove("kb-col-hover"),u.classList.remove("kb-dropzone-hover")},m.ondrop=async r=>{var A,T;((A=r.dataTransfer)==null?void 0:A.types.includes("application/x-kb-col"))?(r.preventDefault(),r.currentTarget.classList.remove("kb-col-hover"),await o.onDropOnIndex(n)):await((T=u.ondrop)==null?void 0:T.call(u,r))};let y=m.createDiv({cls:"kb-column-header"});y.draggable=!0,y.ondragstart=r=>o.onDragStart(n,r),y.createSpan({text:i}),y.createSpan({text:String((F=(S=a.get(i))==null?void 0:S.length)!=null?F:0)});let f=y.createEl("button",{text:"\u22EF"});f.classList.add("kb-ellipsis"),f.onclick=r=>{let b=new C.Menu;b.addItem(T=>T.setTitle("Rename").onClick(async()=>{var P,M,$;let k=(P=await this.promptText("Rename column","Column name",i))==null?void 0:P.trim();if(!k||k===i)return;this.settings.statuses[n]=k,await((M=this.persistSettings)==null?void 0:M.call(this));let N=($=a.get(i))!=null?$:[],B=[];for(let R of N){let W=this.app.vault.getAbstractFileByPath(R.filePath);W instanceof C.TFile&&B.push(V(this.app,W,{status:k}))}try{await Promise.all(B)}catch(R){new C.Notice("Some tasks failed to update")}await this.reload()})),b.addItem(T=>T.setTitle("Delete").onClick(async()=>{var k;this.settings.statuses.splice(n,1),await((k=this.persistSettings)==null?void 0:k.call(this)),this.renderBoard(t)})),b.addItem(T=>T.setTitle("Move right").onClick(async()=>{var N;let k=this.settings.statuses;n>=k.length-1||([k[n+1],k[n]]=[k[n],k[n+1]],await((N=this.persistSettings)==null?void 0:N.call(this)),this.renderBoard(t))})),b.addItem(T=>T.setTitle("Move left").onClick(async()=>{var N;let k=this.settings.statuses;n!==0&&([k[n-1],k[n]]=[k[n],k[n-1]],await((N=this.persistSettings)==null?void 0:N.call(this)),this.renderBoard(t))}));let A=r;b.showAtPosition({x:A.clientX,y:A.clientY})};let u=m.createDiv({cls:"kb-column-body kb-dropzone"}),E=document.createElement("div");E.className="kb-drop-indicator";let D=()=>{E.parentElement&&E.parentElement.removeChild(E)},L=r=>{u.classList.toggle("kb-dropzone-hover",r),r||D()},h=r=>{r.preventDefault(),r.dataTransfer&&(r.dataTransfer.dropEffect="move")},w=r=>{var k;if((k=r.dataTransfer)!=null&&k.types.includes("application/x-kb-col"))return;h(r);let b=Array.from(u.querySelectorAll(".kb-card")),A=b.length,T=r.clientY;for(let N=0;N<b.length;N++){let B=b[N].getBoundingClientRect(),P=B.top+B.height/2;if(T<P){A=N;break}}D(),b.length===0||A>=b.length?u.appendChild(E):u.insertBefore(E,b[A]),L(!0)};u.ondragenter=r=>{var b;(b=r.dataTransfer)!=null&&b.types.includes("application/x-kb-col")||w(r)},u.ondragover=r=>{var b;(b=r.dataTransfer)!=null&&b.types.includes("application/x-kb-col")||w(r)},u.ondragleave=r=>{let b=r.relatedTarget;(!b||!u.contains(b))&&L(!1)},u.ondrop=async r=>{var N,B,P,M,$,R,W,gt,mt,ht,yt,bt;if((N=r.dataTransfer)!=null&&N.types.includes("application/x-kb-col"))return;let A=((B=r.dataTransfer)==null?void 0:B.types.includes("application/x-kb-card"))?(P=r.dataTransfer)==null?void 0:P.getData("application/x-kb-card"):(M=r.dataTransfer)==null?void 0:M.getData("text/plain");if(!A)return;let T=null;try{T=JSON.parse(A)}catch(at){T={path:A}}if(!T||!T.path)return;let k=this.app.vault.getAbstractFileByPath(T.path);if(k instanceof C.TFile)try{let Ct=s.scrollLeft,Q=($=a.get(i))!=null?$:[],it=(mt=T.fromStatus)!=null?mt:String((gt=(W=(R=this.app.metadataCache.getFileCache(k))==null?void 0:R.frontmatter)==null?void 0:W.status)!=null?gt:""),U=(ht=a.get(it))!=null?ht:[],nt=Array.from(u.querySelectorAll(".kb-card")),z=nt.length,St=r.clientY;for(let x=0;x<nt.length;x++){let H=nt[x].getBoundingClientRect(),Y=H.top+H.height/2;if(St<Y){z=x;break}}let X=U.findIndex(x=>x.filePath===T.path);X!==-1&&U.splice(X,1),it===i&&X!==-1&&X<z&&(z=Math.max(0,z-1));let rt=Q.find(x=>x.filePath===T.path);if(!rt){let x=this.app.metadataCache.getFileCache(k);rt={filePath:T.path,fileName:k.name.replace(/\.md$/,""),frontmatter:(yt=x==null?void 0:x.frontmatter)!=null?yt:{}}}Q.splice(z,0,rt);let xt=/^(completed|done)$/i.test(i),Dt=/in\s*progress/i.test(i),ot=[];for(let x=0;x<Q.length;x++){let H=Q[x],Y=this.app.vault.getAbstractFileByPath(H.filePath);if(!(Y instanceof C.TFile))continue;let q={order:x};H.filePath===T.path&&String((bt=H.frontmatter.status)!=null?bt:"")!==i&&(q.status=i,xt&&(q.endDate=new Date().toISOString().slice(0,10)),Dt&&(q.startDate=new Date().toISOString().slice(0,10))),ot.push(V(this.app,Y,q))}if(it!==i)for(let x=0;x<U.length;x++){let H=U[x],Y=this.app.vault.getAbstractFileByPath(H.filePath);if(!(Y instanceof C.TFile))continue;let q={order:x};ot.push(V(this.app,Y,q))}try{await Promise.all(ot),new C.Notice("Moved")}catch(x){new C.Notice("Failed to move: "+x.message)}L(!1),await this.reload();let kt=t.querySelector(".kb-kanban");kt&&(kt.scrollLeft=Ct)}catch(at){new C.Notice("Failed to move: "+at.message)}};for(let r of(I=a.get(i))!=null?I:[]){if(r.frontmatter.archived)continue;let b=u.createDiv({cls:"kb-card",attr:{draggable:"true"}});b.ondragstart=P=>{var $,R;P.stopPropagation();let M=JSON.stringify({path:r.filePath,fromStatus:i});($=P.dataTransfer)==null||$.setData("application/x-kb-card",M),(R=P.dataTransfer)==null||R.setData("text/plain",M),P.dataTransfer&&(P.dataTransfer.effectAllowed="move")},b.createDiv({cls:"kb-card-title",text:(j=r.frontmatter.title)!=null?j:r.fileName}),b.createDiv().createSpan({cls:"kb-chip",text:(J=r.frontmatter.priority)!=null?J:""});let T=b.createDiv({cls:"kb-card-footer"}),k=r.frontmatter.createdAt||"";k&&T.createSpan({cls:"kb-card-ts",text:new Date(k).toLocaleString()});let N=T.createEl("button",{text:"\u22EF"});N.classList.add("kb-ellipsis"),N.onclick=P=>{let M=new C.Menu;M.addItem(R=>R.setTitle("Archive").onClick(async()=>{try{await V(this.app,this.app.vault.getAbstractFileByPath(r.filePath),{archived:!0}),new C.Notice("Task archived"),await this.reload()}catch(W){new C.Notice("Failed to archive task")}})),M.addItem(R=>R.setTitle("Delete").onClick(async()=>{try{await this.app.vault.delete(this.app.vault.getAbstractFileByPath(r.filePath)),new C.Notice("Task deleted"),await this.reload()}catch(W){new C.Notice("Failed to delete task")}}));let $=P;M.showAtPosition({x:$.clientX,y:$.clientY})};let B=T.createEl("button",{text:"Open"});B.addClass("kb-card-btn"),B.onclick=async()=>{let P=this.app.vault.getAbstractFileByPath(r.filePath);P instanceof C.TFile&&await this.app.workspace.getLeaf(!0).openFile(P)}}});let g=s.createDiv({cls:"kb-column kb-column-add"}).createEl("button",{text:"+ Add column"});g.classList.add("kb-button"),g.onclick=async()=>{var n,m;let i=(n=await this.promptText("New column","Column name"))==null?void 0:n.trim();i&&(this.settings.statuses.push(i),await((m=this.persistSettings)==null?void 0:m.call(this)),this.renderBoard(t))}}};var st=class extends O.Plugin{constructor(){super(...arguments);this.settings=ct}async onload(){await this.loadSettings(),await this.migrateSettingsIfNeeded(),this.addSettingTab(new Z(this.app,this)),this.registerView(K,t=>new et(t,this.settings,()=>this.saveSettings())),this.addCommand({id:"open-tasks-pane",name:"Open Tasks (Grid/Board Tabs)",callback:()=>this.activateTabsView()}),this.addCommand({id:"create-task",name:"Create Task from Template",callback:()=>this.createTaskFromTemplate()}),this.addCommand({id:"create-cr",name:"Create Change Request (CR) from Template",callback:()=>this.createCrFromTemplate()}),this.addRibbonIcon("sheets-in-box","Open Tasks (Tabs)",()=>this.activateTabsView()),this.registerEvent(this.app.metadataCache.on("changed",async t=>{var v;if(!(t instanceof O.TFile))return;let e=this.settings.taskFolder||"Tasks";if(!t.path.startsWith(e+"/"))return;let s=(v=this.app.metadataCache.getFileCache(t))==null?void 0:v.frontmatter;if(!s)return;let a=String(s.status||""),o=/^(completed|done)$/i.test(a),d=/in\s*progress/i.test(a),g=String(s.endDate||""),p=String(s.startDate||"");if(o&&!g)try{await V(this.app,t,{endDate:new Date().toISOString().slice(0,10)})}catch(i){}if(d&&!p)try{await V(this.app,t,{startDate:new Date().toISOString().slice(0,10)})}catch(i){}}))}async migrateSettingsIfNeeded(){var v,i;let t=!1,e=(v=this.settings.templateFields)!=null?v:[],s=e.length;this.settings.templateFields=e.filter(n=>n.key!=="due"),this.settings.templateFields.length!==s&&(t=!0);let a=this.settings.templateFields.some(n=>n.key==="startDate"),o=this.settings.templateFields.some(n=>n.key==="endDate"),d=this.settings.templateFields.some(n=>n.key==="notes");a||(this.settings.templateFields.splice(5,0,{key:"startDate",label:"Start Date",type:"date"}),t=!0),o||(this.settings.templateFields.splice(6,0,{key:"endDate",label:"End Date",type:"date"}),t=!0),d||(this.settings.templateFields.push({key:"notes",label:"Notes",type:"freetext"}),t=!0);let g=(i=this.settings.gridVisibleColumns)!=null?i:[],p=g.indexOf("due");p!==-1&&(g.splice(p,1,"startDate","endDate"),this.settings.gridVisibleColumns=g,t=!0),g.includes("notes")||(this.settings.gridVisibleColumns.push("notes"),t=!0),t&&await this.saveSettings()}onunload(){}async loadSettings(){this.settings=Object.assign({},ct,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async activateTabsView(){let t=this.getRightLeaf();await t.setViewState({type:K,active:!0}),this.app.workspace.revealLeaf(t)}getRightLeaf(){var e;let t=this.app.workspace.getLeavesOfType(K);return t.length>0?t[0]:(e=this.app.workspace.getRightLeaf(!1))!=null?e:this.app.workspace.getLeaf(!0)}async createTaskFromTemplate(){new ut(this.app,this.settings.templateFields,this.settings.statuses,async e=>{var L,h;let s=this.settings.taskFolder||"Tasks";await dt(this.app,s);let a=String(e.crNumber||"").trim(),o=String(e.taskNumber||"").trim(),d=String(e.service||"").trim(),g="";if(a){let w=await pt(this.app,this.settings,a);if(w){let S=(L=this.app.metadataCache.getFileCache(w))==null?void 0:L.frontmatter;g=String((h=S==null?void 0:S.title)!=null?h:""),g||(g=w.name.replace(/\.md$/i,"").replace(/^CR-\d+\s*-\s*/i,""))}}let p=[a,o].filter(Boolean).join(" "),v=d?` - [${d}]`:"",i=g.trim()||`Task ${new Date().toISOString().slice(0,10)}`,n=p?`[${p}] ${i}${v}`:`${i}${v}`,m=`${n}.md`,y=`${s}/${m}`,f={};for(let[w,S]of Object.entries(e))Array.isArray(S)?S.length>0&&(f[w]=S):typeof S=="string"?(S.trim()!==""||w==="notes")&&(f[w]=S.trim()):S!=null&&(f[w]=S);f.title=n,f.createdAt=new Date().toISOString();let u=f.crNumber;if(u)try{let w=await pt(this.app,this.settings,u);w&&(f.crLink=Tt(w.path))}catch(w){}let E=tt(f);await this.app.vault.create(y,`${E}

`);let D=this.app.vault.getAbstractFileByPath(y);D instanceof O.TFile&&await this.app.workspace.getLeaf(!0).openFile(D)}).open()}async createCrFromTemplate(){var s;let t=(s=this.settings.crTemplateFields)!=null?s:[{key:"number",label:"CR Number",type:"text"},{key:"title",label:"Title",type:"text"},{key:"emailSubject",label:"Email Subject",type:"text"},{key:"solutionDesign",label:"Solution design link",type:"url"},{key:"description",label:"Description",type:"text"}];new ft(this.app,t,async a=>{let o=this.settings.crFolder||"Change Requests";await dt(this.app,o);let d=(a.number||"").trim();d||(d=await wt(this.app,this.settings)),/^CR-\d+$/i.test(d)||(d="CR-"+d.replace(/[^0-9]/g,""));let g=(a.title||"").trim()||d,p=`${d} - ${g}.md`,v=`${o}/${p}`,i={};for(let[y,f]of Object.entries(a))Array.isArray(f)?f.length>0&&(i[y]=f):typeof f=="string"?f.trim()!==""&&(i[y]=f.trim()):f!=null&&(i[y]=f);i.number=d,i.title=g;let n=tt(i);await this.app.vault.create(v,`${n}

`);let m=this.app.vault.getAbstractFileByPath(v);m instanceof O.TFile&&await this.app.workspace.getLeaf(!0).openFile(m)}).open()}},ut=class extends O.Modal{constructor(t,e,s,a){super(t);this.inputs=new Map;this.fields=e,this.statuses=s,this.onSubmit=a}onOpen(){var D,L;let{contentEl:t}=this;t.empty(),t.addClass("kb-container"),t.createEl("h2",{text:"New Task"});let e=t.createDiv({cls:"setting-item"});e.createDiv({cls:"setting-item-name",text:"Status"});let a=e.createDiv({cls:"setting-item-control"}).createEl("select");for(let h of this.statuses){let w=a.createEl("option",{text:h});w.value=h}a.value=(D=this.statuses[0])!=null?D:"",this.inputs.set("status",a);let o=t.createDiv({cls:"setting-item"});o.createDiv({cls:"setting-item-name",text:"CR Number"});let g=o.createDiv({cls:"setting-item-control"}).createEl("input");g.addClass("kb-input"),g.placeholder="e.g. CR-6485",g.type="text",this.inputs.set("crNumber",g);let p=t.createDiv({cls:"setting-item"});p.createDiv({cls:"setting-item-name",text:"Task Number"});let i=p.createDiv({cls:"setting-item-control"}).createEl("input");i.addClass("kb-input"),i.placeholder="e.g. T-01",i.type="text",this.inputs.set("taskNumber",i);let n=t.createDiv({cls:"setting-item"});n.createDiv({cls:"setting-item-name",text:"Service Name"});let y=n.createDiv({cls:"setting-item-control"}).createEl("input");y.addClass("kb-input"),y.placeholder="Service name",y.type="text",this.inputs.set("service",y);for(let h of this.fields){if(h.key==="status"||h.key==="title"||h.key==="due"||h.key==="crNumber"||h.key==="taskNumber"||h.key==="service")continue;let w=t.createDiv({cls:"setting-item"});w.createDiv({cls:"setting-item-name",text:h.label});let S=w.createDiv({cls:"setting-item-control"});if(h.type==="status"||h.key==="priority"){let F=S.createEl("select");F.addClass("kb-input");let I=h.key==="status"?this.statuses:["Urgent","High","Medium","Low"];for(let j of I){let J=F.createEl("option",{text:j});J.value=j}F.value=h.key==="status"?(L=this.statuses[0])!=null?L:"":"Medium",this.inputs.set(h.key,F)}else if(h.type==="freetext"){w.style.display="block",w.style.width="100%";let F=w.querySelector(".setting-item-name");F&&(F.style.display="block"),S.style.width="100%",S.style.marginTop="8px";let I=S.createEl("textarea");I.addClass("kb-input"),I.placeholder=h.label,I.rows=4,I.style.resize="vertical",I.style.minHeight="80px",I.style.width="100%",this.inputs.set(h.key,I)}else{let F=S.createEl("input");F.addClass("kb-input"),F.placeholder=h.label,h.type==="date"?F.type="date":h.type==="number"?F.type="number":F.type="text",this.inputs.set(h.key,F)}}let f=t.createDiv({cls:"modal-button-container"}),u=f.createEl("button",{text:"Cancel"});u.addClass("mod-warning"),u.onclick=()=>this.close();let E=f.createEl("button",{text:"Create Task"});E.addClass("mod-cta"),E.onclick=async()=>{var w;let h={};for(let[S,F]of this.inputs.entries()){let I=F,j=I.tagName==="TEXTAREA"?I.value:I.value.trim();h[S]=j}h.status||(h.status=(w=this.statuses[0])!=null?w:"Backlog"),h.priority=h.priority||"Medium",await this.onSubmit(h),this.close()}}},ft=class extends O.Modal{constructor(t,e,s){super(t);this.inputs=new Map;this.fields=e,this.onSubmit=s}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("kb-container"),t.createEl("h2",{text:"New Change Request"});for(let o of this.fields){let d=t.createDiv({cls:"setting-item"});d.createDiv({cls:"setting-item-name",text:o.label});let p=d.createDiv({cls:"setting-item-control"}).createEl("input");p.addClass("kb-input"),p.placeholder=o.label,o.type==="date"?p.type="date":o.type==="number"?p.type="number":o.type==="url"?p.type="url":p.type="text",this.inputs.set(o.key,p)}let e=t.createDiv({cls:"modal-button-container"}),s=e.createEl("button",{text:"Cancel"});s.addClass("mod-warning"),s.onclick=()=>this.close();let a=e.createEl("button",{text:"Create CR"});a.addClass("mod-cta"),a.onclick=async()=>{let o={};for(let[d,g]of this.inputs.entries()){let p=g.value.trim();o[d]=p}o.title||(o.title="Untitled CR"),o.priority||(o.priority="Medium"),await this.onSubmit(o),this.close()}}};
